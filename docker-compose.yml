version: "2.0"
services:
  installer:
    build: ./docker-images/installer
    container_name: magento1_installer
    networks:
      - custom_magento1
    environment:
      MYSQL_HOST: mysql
      MYSQL_USER: root
      MYSQL_PASSWORD: pw
      MAGENTO_ROOT: /var/www/html/web
    volumes_from:
      - nginx
    volumes:
      - ./config/installer/bin/install.sh:/bin/install.sh
    links:
      - "mysql:mysql"
      - "maildev:maildev"
    entrypoint: /bin/install.sh
  nginx:
    image: nginx:latest
    container_name: magento1_nginx
    networks:
      - custom_magento1
    ports:
      - "80:80"
      - "443:443"
    volumes:
          - ./logs/nginx:/var/log/nginx
          - ./config/ssl/cert.pem:/etc/nginx/ssl/cert.pem
          - ./config/ssl/cert.key:/etc/nginx/ssl/cert.key
          - ./config/nginx/nginx.conf:/etc/nginx/nginx.conf
          - ./config/nginx/sites-enabled/default.conf:/etc/nginx/conf.d/default.conf
          - ./config/nginx/includes:/etc/nginx/includes
          - ./config/nginx/custom-locations:/etc/nginx/custom-locations
    volumes_from:
          - php
    links:
      - "mysql:mysql"
      - "maildev:maildev"
  php:
    build: ./docker-images/php
    container_name: magento1_php
    networks:
      - custom_magento1
    links:
      - "cache:rediscache"
      - "sessions:redissession"
      - "mysql:mysql"
      - "maildev:maildev"
    volumes:
      - .:/var/www/html
  cache:
    image: redis:latest
    container_name: magento1_redis_cache
    networks:
    - custom_magento1
  sessions:
    image: redis:latest
    container_name: magento1_redis_sessions
    networks:
    - custom_magento1
  mysql:
    image: mysql:5.5
    container_name: magento1_mysql
    networks:
      - custom_magento1
    ports:
      - "3307:3306"
    environment:
      MYSQL_ROOT_PASSWORD: pw
    volumes:
      - ./data/mysql:/var/lib/mysql
      - ./data/dump:/etc/dump
  phpmyadmin:
    image: phpmyadmin/phpmyadmin
    container_name: magento1_phpmyadmin
    networks:
        - custom_magento1
    ports:
      - "8081:80"
    links:
      - "mysql:mysql"
    environment:
      PMA_HOST: "mysql"
      PMA_PORT: 3306
  maildev:
    image: djfarrelly/maildev
    container_name: magento1_maildev
    networks:
        - custom_magento1
    ports:
     - 8282:80
networks:
    custom_magento1:
        ipam:
            driver: default
            config:
                - subnet: 172.80.0.0/24